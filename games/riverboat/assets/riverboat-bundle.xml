<?xml version="1.0" encoding="UTF-8"?>

<xbundle name="riverboat">
  <passage id="about" header="Riverboat" button="Boat Away">
    The Riverboat on the River Effluvious.
  </passage>

  <room id="starting-room" name="Hillock">
    <description>
      You are standing on a grassy hillock.
    </description>
    <exits>
      <exit room="playroom" pos="N" />
    </exits>
  </room>

  <room id="playroom" name="Child's Playroom" exitName="Playroom">
    <description script="bsh">
      out("To the east is a dungeon: " + rooms.get("dungeon").getDescription());
      out("@p");
      out("After " + gm.getNumTurns() + " turns, it's pretty messy in the " + room.getName());
    </description>
    <exits>
      <exit room="starting-room" pos="S"/>
    </exits>
  </room>

  <entity id="stick" name="Stick" attributes="takeable, equippable" inRoom="starting-room">
    <script fileRef="stick-script.bsh" />
    <description>
      A little stick.
    </description>
  </entity>

  <entity id="chest" name="Teak Chest" type="container" inRoom="starting-room">
    <attributes>
      <a>locked</a>
    </attributes>
    <description format="ftl">
      ${entity.defName?cap_first} is a chest made of wood.
    </description>
    <key>wood-key</key>
  </entity>

  <entity id="mirror" name="Magic Mirror" attributes="takeable">
    <description format="ftl">
      First we look at the chest:
      @p
      ¬¬¬¬${entities["chest"].description}
      @p
      And then, in ${entity.defName}, you see that the door is [#if state.doorOpened]open[#else]closed[/#if].
    </description>
    <script><![CDATA[
      Action frob = Meterman2.actions.registerAction("FROB", "Frobnicate");
      List actions = new ArrayList(4);

      List getActions(Entity e) {
          actions.clear();
          actions.addAll(e.getImpl().getActions(e));
          actions.add(frob);
          return actions;
      }

      boolean processAction(Entity e, Action action) {
          if (action.equals(frob)) {
              println("Frobnicate!");
              Meterman2.actions.getAction("CONTAINER_PUT").setTemplateText("Frob %s");
              return true;
          } else {
              return false;
          }
      }
    ]]>
    </script>
  </entity>

  <entity id="wood-key" name="Wood Key" inRoom="starting-room" attributes="takeable">
    <description script="bsh">
      out("You look at " + entity.getDefName() + " and feel a little strange");
    </description>
  </entity>

  <entity id="iron-door" type="door" name="Iron Door" closedExitLabel="Closed Iron Door" attributes="closed">
    <description>A stalwart iron door.</description>
    <connects room1="playroom" pos1="E" room2="dungeon" pos2="W" />
    <script><![CDATA[
      boolean processAction(Entity e, Action action) {
          boolean b = e.getImpl().processAction(e, action);
          state.doorOpened = !e.getAttributes().get(SystemAttributes.CLOSED);
          return b;
      }
    ]]>
    </script>
  </entity>

  <room id="dungeon" name="Dark Dungeon">
    <description script="bsh">
      out("Oh my, this is one " + room.getName() + "!");
    </description>
  </room>

  <entity id="mike" type="talking" name="Mike" attributes="proper-name" topics="GREETING">
    <inRoom>playroom</inRoom>
    <description>It's your old bud Mike!</description>
    <topicmap>
      <topic id="GREETING" addTopics="plumbing, dungeon" removeTopics="GREETING">
        <label>Hey man</label>
        <text>Hey man!@p What's going on?</text>
      </topic>
      <topic id="plumbing" label="How's your plumbing?">
        <text script="bsh">
          if (Utils.randInt(0, 1) == 0)
            out("The plumbing is good.");
          else
            out("It's not so good at all, leaks everywhere.");
        </text>
      </topic>
      <topic id="dungeon" label="What's up with that dungeon?" removeTopics="all" addTopics="GREETING">
        <text>That is one scary dungeon!</text>
      </topic>
    </topicmap>

    <script>
      String getOtherTopicLabel(Talker talker) {
          return "Something else, actually...";
      }

      void talkOther(Talker talker, String topic) {
          println("I don't know much about '" + topic + "'");
      }
    </script>
  </entity>

  <player id="player" inRoom="starting-room">
    <inventory>
      <item equipped="true">stick</item>
      <item>mirror</item>
    </inventory>
  </player>

  <actions id="riverboat-actions">
    <action name="LOOK" templateText="Survey Scene" />
    <action name="WAIT" templateText="Bide Time" />
  </actions>
</xbundle>
